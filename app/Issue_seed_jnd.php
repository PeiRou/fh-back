<?php
/**
 * 11选5玩法结算
 * User: Zoe
 * Date: 2019/4/24
 * Time: 下午22:02
 */

namespace App;

use App\Excel;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;

class Issue_seed_jnd extends Command
{
    protected $SummerStart = 20190310;  //夏令开始
    protected $SummerEnd = 20191103;    //夏令结束
    protected $onSummer = array("20:01:00","20:04:30","20:08:00","20:11:30","20:15:00","20:18:30","20:22:00","20:25:30","20:29:00","20:32:30","20:36:00","20:39:30","20:43:00","20:46:30","20:50:00","20:53:30","20:57:00","21:00:30","21:04:00","21:07:30","21:11:00","21:14:30","21:18:00","21:21:30","21:25:00","21:28:30","21:32:00","21:35:30","21:39:00","21:42:30","21:46:00","21:49:30","21:53:00","21:56:30","22:00:00","22:03:30","22:07:00","22:10:30","22:14:00","22:17:30","22:21:00","22:24:30","22:28:00","22:31:30","22:35:00","22:38:30","22:42:00","22:45:30","22:49:00","22:52:30","22:56:00","22:59:30","23:03:00","23:06:30","23:10:00","23:13:30","23:17:00","23:20:30","23:24:00","23:27:30","23:31:00","23:34:30","23:38:00","23:41:30","23:45:00","23:48:30","23:52:00","23:55:30","23:59:00","0:02:30","0:06:00","0:09:30","0:13:00","0:16:30","0:20:00","0:23:30","0:27:00","0:30:30","0:34:00","0:37:30","0:41:00","0:44:30","0:48:00","0:51:30","0:55:00","0:58:30","1:02:00","1:05:30","1:09:00","1:12:30","1:16:00","1:19:30","1:23:00","1:26:30","1:30:00","1:33:30","1:37:00","1:40:30","1:44:00","1:47:30","1:51:00","1:54:30","1:58:00","2:01:30","2:05:00","2:08:30","2:12:00","2:15:30","2:19:00","2:22:30","2:26:00","2:29:30","2:33:00","2:36:30","2:40:00","2:43:30","2:47:00","2:50:30","2:54:00","2:57:30","3:01:00","3:04:30","3:08:00","3:11:30","3:15:00","3:18:30","3:22:00","3:25:30","3:29:00","3:32:30","3:36:00","3:39:30","3:43:00","3:46:30","3:50:00","3:53:30","3:57:00","4:00:30","4:04:00","4:07:30","4:11:00","4:14:30","4:18:00","4:21:30","4:25:00","4:28:30","4:32:00","4:35:30","4:39:00","4:42:30","4:46:00","4:49:30","4:53:00","4:56:30","5:00:00","5:03:30","5:07:00","5:10:30","5:14:00","5:17:30","5:21:00","5:24:30","5:28:00","5:31:30","5:35:00","5:38:30","5:42:00","5:45:30","5:49:00","5:52:30","5:56:00","5:59:30","6:03:00","6:06:30","6:10:00","6:13:30","6:17:00","6:20:30","6:24:00","6:27:30","6:31:00","6:34:30","6:38:00","6:41:30","6:45:00","6:48:30","6:52:00","6:55:30","6:59:00","7:02:30","7:06:00","7:09:30","7:13:00","7:16:30","7:20:00","7:23:30","7:27:00","7:30:30","7:34:00","7:37:30","7:41:00","7:44:30","7:48:00","7:51:30","7:55:00","7:58:30","8:02:00","8:05:30","8:09:00","8:12:30","8:16:00","8:19:30","8:23:00","8:26:30","8:30:00","8:33:30","8:37:00","8:40:30","8:44:00","8:47:30","8:51:00","8:54:30","8:58:00","9:01:30","9:05:00","9:08:30","9:12:00","9:15:30","9:19:00","9:22:30","9:26:00","9:29:30","9:33:00","9:36:30","9:40:00","9:43:30","9:47:00","9:50:30","9:54:00","9:57:30","10:01:00","10:04:30","10:08:00","10:11:30","10:15:00","10:18:30","10:22:00","10:25:30","10:29:00","10:32:30","10:36:00","10:39:30","10:43:00","10:46:30","10:50:00","10:53:30","10:57:00","11:00:30","11:04:00","11:07:30","11:11:00","11:14:30","11:18:00","11:21:30","11:25:00","11:28:30","11:32:00","11:35:30","11:39:00","11:42:30","11:46:00","11:49:30","11:53:00","11:56:30","12:00:00","12:03:30","12:07:00","12:10:30","12:14:00","12:17:30","12:21:00","12:24:30","12:28:00","12:31:30","12:35:00","12:38:30","12:42:00","12:45:30","12:49:00","12:52:30","12:56:00","12:59:30","13:03:00","13:06:30","13:10:00","13:13:30","13:17:00","13:20:30","13:24:00","13:27:30","13:31:00","13:34:30","13:38:00","13:41:30","13:45:00","13:48:30","13:52:00","13:55:30","13:59:00","14:02:30","14:06:00","14:09:30","14:13:00","14:16:30","14:20:00","14:23:30","14:27:00","14:30:30","14:34:00","14:37:30","14:41:00","14:44:30","14:48:00","14:51:30","14:55:00","14:58:30","15:02:00","15:05:30","15:09:00","15:12:30","15:16:00","15:19:30","15:23:00","15:26:30","15:30:00","15:33:30","15:37:00","15:40:30","15:44:00","15:47:30","15:51:00","15:54:30","15:58:00","16:01:30","16:05:00","16:08:30","16:12:00","16:15:30","16:19:00","16:22:30","16:26:00","16:29:30","16:33:00","16:36:30","16:40:00","16:43:30","16:47:00","16:50:30","16:54:00","16:57:30","17:01:00","17:04:30","17:08:00","17:11:30","17:15:00","17:18:30","17:22:00","17:25:30","17:29:00","17:32:30","17:36:00","17:39:30","17:43:00","17:46:30","17:50:00","17:53:30","17:57:00","18:00:30","18:04:00","18:07:30","18:11:00","18:14:30","18:18:00","18:21:30","18:25:00","18:28:30","18:32:00","18:35:30","18:39:00","18:42:30","18:46:00","18:49:30","18:53:00","18:56:30","19:00:00");
    protected $unSummer = array("21:01:00","21:04:30","21:08:00","21:11:30","21:15:00","21:18:30","21:22:00","21:25:30","21:29:00","21:32:30","21:36:00","21:39:30","21:43:00","21:46:30","21:50:00","21:53:30","21:57:00","22:00:30","22:04:00","22:07:30","22:11:00","22:14:30","22:18:00","22:21:30","22:25:00","22:28:30","22:32:00","22:35:30","22:39:00","22:42:30","22:46:00","22:49:30","22:53:00","22:56:30","23:00:00","23:03:30","23:07:00","23:10:30","23:14:00","23:17:30","23:21:00","23:24:30","23:28:00","23:31:30","23:35:00","23:38:30","23:42:00","23:45:30","23:49:00","23:52:30","23:56:00","23:59:30","0:03:00","0:06:30","0:10:00","0:13:30","0:17:00","0:20:30","0:24:00","0:27:30","0:31:00","0:34:30","0:38:00","0:41:30","0:45:00","0:48:30","0:52:00","0:55:30","0:59:00","1:02:30","1:06:00","1:09:30","1:13:00","1:16:30","1:20:00","1:23:30","1:27:00","1:30:30","1:34:00","1:37:30","1:41:00","1:44:30","1:48:00","1:51:30","1:55:00","1:58:30","2:02:00","2:05:30","2:09:00","2:12:30","2:16:00","2:19:30","2:23:00","2:26:30","2:30:00","2:33:30","2:37:00","2:40:30","2:44:00","2:47:30","2:51:00","2:54:30","2:58:00","3:01:30","3:05:00","3:08:30","3:12:00","3:15:30","3:19:00","3:22:30","3:26:00","3:29:30","3:33:00","3:36:30","3:40:00","3:43:30","3:47:00","3:50:30","3:54:00","3:57:30","4:01:00","4:04:30","4:08:00","4:11:30","4:15:00","4:18:30","4:22:00","4:25:30","4:29:00","4:32:30","4:36:00","4:39:30","4:43:00","4:46:30","4:50:00","4:53:30","4:57:00","5:00:30","5:04:00","5:07:30","5:11:00","5:14:30","5:18:00","5:21:30","5:25:00","5:28:30","5:32:00","5:35:30","5:39:00","5:42:30","5:46:00","5:49:30","5:53:00","5:56:30","6:00:00","6:03:30","6:07:00","6:10:30","6:14:00","6:17:30","6:21:00","6:24:30","6:28:00","6:31:30","6:35:00","6:38:30","6:42:00","6:45:30","6:49:00","6:52:30","6:56:00","6:59:30","7:03:00","7:06:30","7:10:00","7:13:30","7:17:00","7:20:30","7:24:00","7:27:30","7:31:00","7:34:30","7:38:00","7:41:30","7:45:00","7:48:30","7:52:00","7:55:30","7:59:00","8:02:30","8:06:00","8:09:30","8:13:00","8:16:30","8:20:00","8:23:30","8:27:00","8:30:30","8:34:00","8:37:30","8:41:00","8:44:30","8:48:00","8:51:30","8:55:00","8:58:30","9:02:00","9:05:30","9:09:00","9:12:30","9:16:00","9:19:30","9:23:00","9:26:30","9:30:00","9:33:30","9:37:00","9:40:30","9:44:00","9:47:30","9:51:00","9:54:30","9:58:00","10:01:30","10:05:00","10:08:30","10:12:00","10:15:30","10:19:00","10:22:30","10:26:00","10:29:30","10:33:00","10:36:30","10:40:00","10:43:30","10:47:00","10:50:30","10:54:00","10:57:30","11:01:00","11:04:30","11:08:00","11:11:30","11:15:00","11:18:30","11:22:00","11:25:30","11:29:00","11:32:30","11:36:00","11:39:30","11:43:00","11:46:30","11:50:00","11:53:30","11:57:00","12:00:30","12:04:00","12:07:30","12:11:00","12:14:30","12:18:00","12:21:30","12:25:00","12:28:30","12:32:00","12:35:30","12:39:00","12:42:30","12:46:00","12:49:30","12:53:00","12:56:30","13:00:00","13:03:30","13:07:00","13:10:30","13:14:00","13:17:30","13:21:00","13:24:30","13:28:00","13:31:30","13:35:00","13:38:30","13:42:00","13:45:30","13:49:00","13:52:30","13:56:00","13:59:30","14:03:00","14:06:30","14:10:00","14:13:30","14:17:00","14:20:30","14:24:00","14:27:30","14:31:00","14:34:30","14:38:00","14:41:30","14:45:00","14:48:30","14:52:00","14:55:30","14:59:00","15:02:30","15:06:00","15:09:30","15:13:00","15:16:30","15:20:00","15:23:30","15:27:00","15:30:30","15:34:00","15:37:30","15:41:00","15:44:30","15:48:00","15:51:30","15:55:00","15:58:30","16:02:00","16:05:30","16:09:00","16:12:30","16:16:00","16:19:30","16:23:00","16:26:30","16:30:00","16:33:30","16:37:00","16:40:30","16:44:00","16:47:30","16:51:00","16:54:30","16:58:00","17:01:30","17:05:00","17:08:30","17:12:00","17:15:30","17:19:00","17:22:30","17:26:00","17:29:30","17:33:00","17:36:30","17:40:00","17:43:30","17:47:00","17:50:30","17:54:00","17:57:30","18:01:00","18:04:30","18:08:00","18:11:30","18:15:00","18:18:30","18:22:00","18:25:30","18:29:00","18:32:30","18:36:00","18:39:30","18:43:00","18:46:30","18:50:00","18:53:30","18:57:00","19:00:30","19:04:00","19:07:30","19:11:00","19:14:30","19:18:00","19:21:30","19:25:00","19:28:30","19:32:00","19:35:30","19:39:00","19:42:30","19:46:00","19:49:30","19:53:00","19:56:30","20:00:00");

    public function main()
    {
        $curDate = date('Ymd');                                     //格式1
        $curDate1 = date('Y-m-d');                                  //格式2
        $curDate2 = date("Y-m-d",strtotime("1 days"));        //换日
        $table = 'game_'.$this->code;

        $redis = \Illuminate\Support\Facades\Redis::connection();          //检查重复执行
        $redis->select(5);
        $key = 'issue_send:'.$this->signature.'_'.$curDate;
        if($redis->exists($key)){
            echo $redis->get($key);
            return false;
        }

        $arrIssue = $curDate>=$this->SummerStart && $curDate<=$this->SummerEnd ?$this->onSummer:$this->unSummer;        //根据不同的令区切换奖期时间

        $checkUpdate = DB::table('issue_seed')->where('id',1)->value($this->code);
        $checkLastIssue = DB::table($table)->select('issue')->where('opentime',$curDate1.' '.$arrIssue[count($arrIssue)-1])->first();
        $lastIssue = @$checkLastIssue->issue;
        if(empty($lastIssue)){
            $curDate = date('Ymd',strtotime("-1 days"));
            $curDate1 = date('Y-m-d',strtotime("-1 days"));
            $curDate2 = date("Y-m-d");                             //换日
            $checkLastIssue = DB::table($table)->select('issue')->where('opentime',$curDate1.' '.$arrIssue[count($arrIssue)-1])->first();
            $lastIssue = @$checkLastIssue->issue;
            if(empty($lastIssue)){
                $str = date('Y-m-d H:i:s').' '.env('APP_NAME').'-'.$this->signature.'期数不可为0';
                writeLog('ISSUE_SEED', $str);
                echo $str;
                $url = self::ZABBIX_BOT_URL.'/telegram?q='.urlencode($str);
                try{
                    $http = app(\GuzzleHttp\Client::class);
                    $http->request('GET',$url,['connect_timeout' => 1]);
                }catch (\Exception $e){
                }
                return '';
            }
        }
        $firstIssue = $lastIssue+1;
        $excelModel = new Excel();
        echo $firstIssue.PHP_EOL;
        $openCode = $excelModel->getGuanIssueNum($firstIssue,$this->code);       //获取官方号码
        if(!isset($openCode["nums"])||empty($openCode["nums"])||empty($openCode["apitime"])){
            echo '官方第一期未开'.PHP_EOL;
            return '';
        }
        $redis->setex($key, 60, 'on');

        $sql = "INSERT INTO ".$table." (issue,opentime) VALUES ";
        $firsrTime = strtotime(substr($openCode["apitime"],-8));    //获取官方第一期时间
        $issueDate = $curDate1.' ';                              //默认当日日期
        for($ii = 0;$ii < count($arrIssue);$ii++){
            if(strtotime($arrIssue[$ii])<$firsrTime&&$ii<=30)
                continue;
            if(substr($arrIssue[$ii-1],0,2)=='0:')
                $issueDate = $curDate2.' ';
            $issue = $firstIssue++;
            $sql .= "('$issue','".$issueDate.$arrIssue[$ii-1]."'),";
        }
        $sql .= "('".++$issue."','".$issueDate.$arrIssue[count($arrIssue)-1]."'),";
        if($checkUpdate == $curDate){
            writeLog('ISSUE_SEED', date('Y-m-d').'期数已存在');
            $redis->setex($key, 79200, $curDate.'-已执行');
        } else {
            $run = DB::statement(rtrim($sql, ',').";");
            if($run == 1){
                $update = DB::table('issue_seed')->where('id',1)->update([
                    $this->code => $curDate
                ]);
                if($update !== 1){
                    writeLog('ISSUE_SEED', 'error');
                }else{
                    $redis->setex($key, 79200, $curDate.'-已执行');
                }
            } else {
                writeLog('ISSUE_SEED', 'error');
            }
        }
    }
}
